name: Release from Release Notes

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  release:
    name: Build exam cards and create GitHub Release
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set TAG env
        run: echo "TAG=${GITHUB_REF_NAME}" >> "$GITHUB_ENV"

      - name: Install TeXLive
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            texlive-latex-recommended \
            texlive-latex-extra \
            texlive-lang-cyrillic

      - name: Build exam cards PDF
        working-directory: tex_form
        run: |
          mkdir -p ../exam_cards
          pdflatex -interaction=nonstopmode -output-directory=../exam_cards main.tex
          pdflatex -interaction=nonstopmode -output-directory=../exam_cards main.tex
          mv ../exam_cards/main.pdf ../exam_cards/exam_cards.pdf

      - name: Extract release notes for tag from RELEASE_NOTES.md
        id: notes
        shell: bash
        run: |
          TAG="${TAG}"
          FILE="RELEASE_NOTES.md"

          if [ ! -f "$FILE" ]; then
            echo "Release notes file '$FILE' not found"
            exit 1
          fi

          CONTENT=$(awk -v tag="## ${TAG}" '
            BEGIN {found=0}
            $0 == tag {found=1; next}
            /^## / && found {exit}
            found {print}
          ' "$FILE")

          if [ -z "$CONTENT" ]; then
            echo "No notes found for tag ${TAG} in ${FILE}"
            exit 1
          fi

          {
            echo 'body<<EOF'
            echo "$CONTENT"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          tag_name: ${{ env.TAG }}
          name: ${{ env.TAG }}
          body: ${{ steps.notes.outputs.body }}
          files: |
            exam_cards/exam_cards.pdf
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
